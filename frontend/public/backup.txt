const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser'); 
const cookieParser = require('cookie-parser');
const { Server } = require('socket.io');
const app = express();
const http = require('http');
const path = require('path');
const fs = require('fs');


//middleware
app.use(cors({
    origin: function (origin, callback) {
        // Allow requests with no origin (like mobile apps or curl requests)
        if (!origin) return callback(null, true);
        return callback(null, origin);
    },
    credentials: true,
}));
app.use(bodyParser.json());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());    
// Serve uploaded files (create folder if you use file uploads)
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

 ///MongoDb all files here


require('./MongoDb/config');
require('./MongoDb/otpSaveMongo/otpSaveMongo');
require('./MongoDb/signupMongo/signupMongo');
require('./MongoDb/chatMongo/chatMongo');
require('./MongoDb/messageMongo/messageMongo');



     // All Routes here




const signup = require('./Routes/signUpRoutes/signUpRoutes');
const verify_signup = require('./Routes/verifySignUpRoutes/verifySignUpRoutes');
const login = require('./Routes/loginRoutes/loginRoutes');
const user = require('./Routes/userRoutes/userRoutes');
const message = require('./Routes/messageRoutes/messageRoutes');
const chat = require('./Routes/chatRoutes/chatRoutes');
const chatSocket = require('./sockets/chatSocket');







  //All Controllers here


app.use('/',signup);
app.use('/',verify_signup);
app.use('/',login);
app.use('/',user);
app.use('/',message);
app.use('/',chat);
app.use('/',chatSocket);

// ---------- Socket.io ----------

const server = http.createServer(app);
const io = new Server(server, {
  cors: { origin: '*',
     credentials: true,
   }   // or mirror Express CORS list
});

io.on('connection', (socket) => {
  chatSocket(io, socket);
});





app.get('/', (req, res) => {
    res.send("Jai Shree Ram");
});

const port = 3000;
app.listen(port, () => {
    console.log(`Server is listening on port number ${port}`); 
});




